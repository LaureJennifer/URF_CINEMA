@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using BaseSolution.Application.DataTransferObjects.Account
@using BaseSolution.Application.DataTransferObjects.Account.Request
@using BaseSolution.Application.DataTransferObjects.Customer
@using BaseSolution.Application.DataTransferObjects.Customer.Request
@using BaseSolution.Application.DataTransferObjects.DepartmentFilm.Request
@using BaseSolution.Application.DataTransferObjects.Film
@using BaseSolution.Application.DataTransferObjects.Film.Request
@using BaseSolution.Application.DataTransferObjects.Role
@using BaseSolution.Application.DataTransferObjects.Role.Request
@using BaseSolution.Application.DataTransferObjects.User
@using BaseSolution.Application.DataTransferObjects.User.Request
@using BaseSolution.BlazorServer.Components.SignUp;
@using BaseSolution.BlazorServer.Components.ForgotPassword;
@using BaseSolution.BlazorServer.Repositories.Interfaces

@inject IDialogService DialogService
@inject ISnackbar _snackbar
@inject NavigationManager _navigation

@if (!showLogin)
{
    <MudDialog>
        <DialogContent>
            <MudTabs Elevation="4" Rounded="true" Centered="true">
                <MudTabPanel Text="Đăng nhập" />
                <MudTabPanel @onclick="OpenDialog" Variant="Variant.Filled" Text="Đăng ký" />
            </MudTabs>
            <MudForm Model="_login" @ref="form">
                <MudTextField T="string" @bind-Value="_login.UserName" Label="Tài khoản" />
                <MudTextField @bind-Value="_login.Password" Label="Mật khẩu" Variant="Variant.Text" InputType="@PassWordInput" Adornment="Adornment.End" OnAdornmentClick="ButtonTestclick" AdornmentAriaLabel="Show Password" AdornmentIcon="@PassWordInputIcon" />
                <MudGrid Class="mt-3">
                    <MudItem xs="8">
                        <MudText @onclick="OpenDialogg" Variant="Variant.Filled" Color="Color.Warning"> Quên mật khẩu ? </MudText>
                    </MudItem>
                    <MudItem xs="4">
                    </MudItem>
                </MudGrid>
            </MudForm>
            <MudRadioGroup @bind-SelectedOption="@option" ReadOnly="ReadOnly">
                @foreach (var role in _lstOption)
                {
                    <MudRadio Option="role.Name">@role.Name</MudRadio>
                }

            </MudRadioGroup> 
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Error" OnClick="Cancel">Hủy</MudButton>
            <MudButton OnClick="HandleValidSubmit" Color="Color.Success">Đăng nhập</MudButton>
        </DialogActions>
    </MudDialog>

}

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Inject]
    public ILoginRepo _loginRepo { get; set; }

    MudForm form;

    UserDto _userDto = new();


    private List<UserDto> _lstUser;
    private List<RoleDto> _lstRole;
    LoginInputRequest _login = new();
    CustomerDto _customerDto = new();
    private bool showLogin = false;

    private ViewRoleWithPaginationRequest roleRequest = new();
    public ViewUserWithPaginationRequest obj = new();
    public ViewCustomerWithPaginationRequest Obj = new();
    ViewLoginInput viewLoginInput = new();
    string? error;
    bool _showError = false;
    private string RoleId{ get; set; }
    public ViewLoginInput _loginVM = new();

    RoleDto _roleDto = new();

    public class Option
    {
        public string Name { get; set; }
    }
    public bool ReadOnly { get; set; }
    public List<Option> _lstOption = new List<Option>
    {
        new Option { Name = "nhân viên" },
        new Option { Name = "khách hàng" }
    };

    [Inject]
    public IUserRepo _userRepo { get; set; }
    [Inject]
    public ICustomerRepo _customerRepo { get; set; }
    [Inject]
    public IRoleRepo _roleRepo { get; set; }
    [Parameter]
    public Guid idDepartment { get; set; }

    // private string customer_ = "Khách hàng";
    // private string employee_ = "nhân viên";

    [Parameter]public string customerid{ get; set; }
    public List<CustomerDto> _lst;
    private List<RoleDto> lstRole = new();
    public string departmentid{ get; set; }
    bool isShow;
    InputType PassWordInput = InputType.Password;
    string PassWordInputIcon = Icons.Material.Filled.VisibilityOff;

    public string option { get; set; }

    void ButtonTestclick()
    {
        @if (isShow)
        {
            isShow = false;
            PassWordInputIcon = Icons.Material.Filled.VisibilityOff;
            PassWordInput = InputType.Password;
        }
        else
        {
            isShow = true;
            PassWordInputIcon = Icons.Material.Filled.Visibility;
            PassWordInput = InputType.Text;
        }
    }

    void Submit() => MudDialog.Close(DialogResult.Ok(true));
    void Cancel() => MudDialog.Cancel();
    private void OpenDialog()
    {
        DialogOptions closeOnEscapeKey = new DialogOptions() { CloseOnEscapeKey = true };

        DialogService.Show<SignUp>("Đăng ký", closeOnEscapeKey);
    }
    private void OpenDialogg()
    {
        DialogOptions closeOnEscapeKey = new DialogOptions() { CloseOnEscapeKey = true };

        DialogService.Show<ForgotPassword>("Quên mật khẩu", closeOnEscapeKey);
    }
    [Inject] private IDialogService _dialogService { get; set; } = null!;

    private async Task HandleValidSubmit()
    {
        if (option.ToLower() == "nhân viên")
        {
            await LoginSuccess();
        }
        else if (option.ToLower() == "khách hàng")
        {
            await LoginSuccessCustomer();
        }
        else
        {
            _snackbar.Add("Cần phải chọn vai trò phía đăng nhập");
        }
    }

    private async Task LoginSuccessCustomer()
    {
        var result = await _loginRepo.LoginCustomer(_login);
        if (result !=null)
        {
            _snackbar.Add("Đăng nhập thành công", Severity.Success);
            _navigation.NavigateTo($"/home/{departmentid}"); // sau khi login xong thì muốn chuyển đến màn nào thì chuyển sang màn đó
                                                             // LoadData();
            showLogin = true;
        }
        else
        {
            _navigation.NavigateTo("/");
        }
    }
    private async Task LoginUser()
    {
        bool loginSuccessful = false;
        foreach (var item in _lstUser)
        {
            if (_login.UserName == item.UserName && _login.Password == item.PassWord)
            {
                // if (viewLoginInput.RoleId != item.RoleId)
                // {
                //     _snackbar.Add("Quyền đăng nhập không tồn tại!", Severity.Error);
                // }
                // else
                // {
                LoginSuccess();
                loginSuccessful = true;
                break;
                // }
            }
        }
        if (!loginSuccessful && !_lstUser.Any(user => user.UserName == _login.UserName && user.PassWord == _login.Password))
        {
            _snackbar.Add("Tài khoản hoặc mật khẩu không đúng!", Severity.Error);
        }

        return;
        // var result = await _loginRepo.SignIn(_login);
        // if (result != null)
        // {
        //     _snackbar.Add("Đăng nhập thành công", Severity.Success);
        //     _navigation.NavigateTo($"/user/list"); // sau khi login xong thì muốn chuyển đến màn nào thì chuyển sang màn đó
        //     showLogin = true;
        // }
        // else
        // {
        //     _navigation.NavigateTo("/");
        // }
    }
    private async Task LoginSuccess()
    {

        var result = await _loginRepo.SignIn(_login);
        if (result != null)
        {
            // if (result.Code.ToLower() == "Admin" || result.Code.ToLower() == "Nhân viên")
            // {
                _snackbar.Add("Đăng nhập thành công", Severity.Success);
                _navigation.NavigateTo("/user/list"); // sau khi login xong thì muốn chuyển đến màn nào thì chuyển sang màn đó
        }
        else
        {
            _navigation.NavigateTo("/"); // sau khi login xong thì muốn chuyển đến màn nào thì chuyển sang màn đó
        }   
    }
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    public async Task LoadData()
    {
        var result = await _userRepo.GetAllActive(obj);
        _lstUser = result.Data!.Data.ToList();
        var result1 = await _roleRepo.GetAllActive();
        _lstRole = result1.Data!.Data.ToList();

    }
}