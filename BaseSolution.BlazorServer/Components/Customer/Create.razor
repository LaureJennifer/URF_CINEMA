@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using BaseSolution.Application.DataTransferObjects.Customer
@using BaseSolution.Application.DataTransferObjects.Customer.Request
@using BaseSolution.BlazorServer.Data.ValueObjects.Common
@using BaseSolution.BlazorServer.Repositories.Interfaces
@using BaseSolution.Domain.Entities
@using BaseSolution.Domain.Enums
@using static MudBlazor.CategoryTypes

@inject IDialogService DialogService
@inject ISnackbar _snackbar
@inject NavigationManager _navigate;

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.Code" Label="Mã khách hàng*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.Name" Label="Họ và tên*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.DateOfBirth" Label="Ngày sinh*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.PhoneNumber" Label="Số điện thoại*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.Email" Label="Email*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.Address" Label="Địa chỉ*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.UserName" Label="Tên tài khoản*" />
            </MudItem>
            <MudItem xs="6" sm="6" md="6">
                <MudTextField @bind-Value="_customerDto.PassWord" Label="Mật khẩu*" />
            </MudItem>
        </MudGrid>
        <MudGrid Class="mt-3">
            <MudItem xs="6" sm="6" md="6">
                <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload" for="@context">Ảnh</MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudItem>
            @if (imageUrl != null)
            {
                <MudItem xs="6" sm="6" md="6">
                    <MudImage Style="width:60%;" Src="@imageUrl" />
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Error" OnClick="Cancel">Hủy</MudButton>
        <MudButton Color="Color.Success" OnClick="OnButtonClicked">Thêm mới</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance _mudDialog { get; set; }

    [Inject]
    public ICustomerRepo _customerRepo { get; set; }

    public CustomerDto _customerDto = new();
    private List<CustomerDto> _lstCustomer { get; set; }

    public CustomerCreateRequest obj = new();
    public ViewCustomerWithPaginationRequest customer_ = new();

    public string imageUrl { get; set; } = "";

    IList<IBrowserFile> files = new List<IBrowserFile>();
    ImageHandle imageHandle = new();


    private async Task UploadFiles(IBrowserFile file)
    {
        imageUrl = @"\image\Customer\" + await imageHandle.AddImage(file, "Customer");
        files.Add(file);
    }

    private async Task OnButtonClicked()
    {
        obj.Code = _customerDto.Code;
        obj.Name = _customerDto.Name;
        obj.DateOfBirth = _customerDto.DateOfBirth;
        obj.PhoneNumber = _customerDto.PhoneNumber;
        obj.Email = _customerDto.Email;
        obj.Address = _customerDto.Address;
        obj.UserName = _customerDto.UserName;
        obj.PassWord = _customerDto.PassWord;
        obj.UrlImage = imageUrl;
        bool? confirm = await DialogService.ShowMessageBox(
     "Xác nhận",
     "Bạn có chắc thêm mới?",
     yesText: "Xác nhận", cancelText: "Hủy");
        if (confirm == true)
        {
            if (_lstCustomer.Any(x => x.UserName.ToLower().Trim().Equals(obj.UserName.Trim().ToLower())))
            {
                _snackbar.Add
                (
                    "Thêm thất bại do trùng tên tài khoản người dùng",
                     Severity.Error
                );
            }
            else
            {
                var result = await _customerRepo.AddAsync(obj);
                if (result == true)
                {
                    _mudDialog.Close(DialogResult.Ok(true));
                    _snackbar.Add("Thêm thành công", Severity.Success);
                    _navigate.NavigateTo("/customer/list");
                    StateHasChanged();
                }
                else
                {
                    _snackbar.Add
                    (
                        "Thêm thất bại",
                         Severity.Error
                    );
                }
            }
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {

        var result = await _customerRepo.GetAllActive(customer_);
        if (result != null)
        {
            _lstCustomer = result.Data.Data.ToList();
        }
    }


    void Cancel() => _mudDialog.Cancel();
}