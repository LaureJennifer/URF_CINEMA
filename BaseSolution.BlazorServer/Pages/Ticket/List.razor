@page "/ticket/list"
@using BaseSolution.Application.DataTransferObjects.Ticket
@using BaseSolution.Application.DataTransferObjects.Ticket.Request
@using BaseSolution.Application.ValueObjects.Common
@using BaseSolution.BlazorServer.Components.Ticket;
@using BaseSolution.BlazorServer.Repositories.Interfaces
@using BaseSolution.Domain.Entities;
@attribute [Authorize(Roles = $"{Roles.Admin},{Roles.Staff}")]

@inject IDialogService _dialogService
@inject ISnackbar _snackbar

<MudPaper Class="pa-5">
    <MudText Class="mt-3" Typo="Typo.h4">Danh sách Vé</MudText>
    <MudGrid>
        <MudItem xs="8">
        </MudItem>
        <MudItem xs="4">
            <MudInput Value="@searchString" ValueChanged="(string str)=>OnSearch(str)" Placeholder="Tìm kiếm theo mã" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" Class="ml-5 mt-2"></MudInput>
        </MudItem>
    </MudGrid>
    @if (_lst == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        if (_lst.Count == 0)
        {
            <MudAlert Severity="Severity.Warning">Không có dữ liệu</MudAlert>
        }
        else
        {
            <MudTable Items="@_lst" Class="mt-4 ">
                <HeaderContent>
                    <MudTh>STT</MudTh>
                    <MudTh>Mã Vé</MudTh>
                    <MudTh>Tên phim</MudTh>
                    <MudTh>Phòng</MudTh>
                    <MudTh>Ghế ngồi</MudTh>
                    <MudTh>Ngày chiếu</MudTh>
                    <MudTh>Giờ chiếu</MudTh>
                    <MudTh>Trạng Thái</MudTh>
                    <MudTh>Chức năng</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Stt">@(_lst.IndexOf(context) + 1)</MudTd>
                    <MudTd DataLabel="Mã Vé">@context.Code</MudTd>
                    <MudTd DataLabel="Tên phim">@context.FilmName</MudTd>
                    <MudTd DataLabel="Phòng">@context.RoomCode</MudTd>
                    <MudTd DataLabel="Ghế ngồi">@context.SeatCode</MudTd>
                    <MudTd DataLabel="Ngày chiếu">@context.ShowDate.ToString("dd/MM/yyyy")</MudTd>
                    <MudTd DataLabel="Giờ chiếu">@context.ShowTime.ToString("hh : mm tt")</MudTd>
                    <MudTd DataLabel="Trạng Thái">@context.Status</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        }
    }
</MudPaper>

@code {
    [Inject]
    public ITicketRepo _ticketRepo { get; set; }

    public List<TicketDto>? _lst { get; set; }

    public ViewTicketWithPaginationRequest obj = new() { PageSize = int.MaxValue - 1 };
    public TicketDeleteRequest _ticketDelete = new();

    string searchString = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData(searchString);

    }

    private async Task LoadData(string textSearch)
    {

        obj.Code = textSearch;

        var result = await _ticketRepo.GetAllActive(obj);
        _lst = result.Data.Data.ToList();

    }
    private async Task OnSearch(string textSearch)
    {
        await LoadData(textSearch);
        StateHasChanged();
    }
}
